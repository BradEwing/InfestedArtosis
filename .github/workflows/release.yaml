name: Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute next version
        id: version
        run: |
          CURRENT=$(sed -n '9s/.*<version>\(.*\)<\/version>.*/\1/p' pom.xml)
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          NEXT_MINOR=$((MINOR + 1))
          NEXT_VERSION="${MAJOR}.${NEXT_MINOR}"
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "next=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Bumping version: $CURRENT -> $NEXT_VERSION"

      - name: Update pom.xml version
        run: sed -i "9s|<version>.*</version>|<version>${{ steps.version.outputs.next }}</version>|" pom.xml

      - name: Set up JDK 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'corretto'
          cache: maven

      - name: Build JAR
        run: mvn --batch-mode --update-snapshots package

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add pom.xml
          git commit -m "release ${{ steps.version.outputs.next }}"
          git push

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.next }}
          name: ${{ steps.version.outputs.next }}
          generate_release_notes: true
          files: target/InfestedArtosis-${{ steps.version.outputs.next }}-jar-with-dependencies.jar
